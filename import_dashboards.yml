---
- hosts: localhost
  connection: local
  gather_facts: false
  vars:
    dashboards_dir: roles/grafana_dashboards/files
    datasource_name: Prometheus
  tasks:
    - name: Find dashboard JSON files
      ansible.builtin.find:
        paths: "{{ dashboards_dir }}"
        patterns: "*.json"
        recurse: true
      register: dashboards_found

    - name: Get Grafana datasources
      ansible.builtin.uri:
        url: "{{ grafana_url }}/api/datasources"
        method: GET
        headers:
          Authorization: "Bearer {{ grafana_api_key }}"
        return_content: true
        status_code: 200
      register: ds_response

    - name: Select Prometheus datasource
      ansible.builtin.set_fact:
        prometheus_ds: "{{ (ds_response.json | selectattr('type','equalto','prometheus') | list | first) | default({}) }}"

    - name: Set datasource name and UID
      ansible.builtin.set_fact:
        datasource_name: "{{ prometheus_ds.name | default(datasource_name) }}"
        prometheus_uid: "{{ prometheus_ds.uid | default('') }}"
    - name: Read dashboard file content
      ansible.builtin.slurp:
        path: "{{ item.path }}"
      loop: "{{ dashboards_found.files }}"
      loop_control:
        label: "{{ item.path }}"
      register: slurped_files

    - name: Write processed dashboards to temp files
      ansible.builtin.copy:
        content: >-
          {{ (item.content | b64decode)
             | replace('${DS_PROMETHEUS}', datasource_name)
             | replace('$datasource', datasource_name)
             | replace('${VAR_DATASOURCE}', datasource_name)
             | replace('${ds_prometheus}', prometheus_uid if prometheus_uid else datasource_name)
             | replace('$ds_prometheus', prometheus_uid if prometheus_uid else datasource_name)
          }}
        dest: "/tmp/{{ item.source | basename }}"
        mode: "0644"
      loop: "{{ slurped_files.results }}"
      loop_control:
        label: "{{ item.source }}"
      register: temp_files

    - name: Import Grafana dashboards (processed)
      community.grafana.grafana_dashboard:
        grafana_url: "{{ grafana_url }}"
        grafana_api_key: "{{ grafana_api_key }}"
        state: present
        commit_message: "Updated by ansible"
        overwrite: true
        path: "{{ item.dest }}"
      loop: "{{ temp_files.results }}"
      loop_control:
        label: "{{ item.dest }}"