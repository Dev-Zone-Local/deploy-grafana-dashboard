 - name: Resolve file path
   ansible.builtin.set_fact:
     dashboard_file: "{{ (item if '/' in item else role_path + '/files/dashboards/' + item) | trim }}"

 - name: Stat dashboard file
   ansible.builtin.stat:
     path: "{{ dashboard_file }}"
   register: dashboard_stat

 - name: Fail if dashboard file not found
   ansible.builtin.fail:
     msg: "Dashboard file {{ dashboard_file }} not found"
   when: not dashboard_stat.stat.exists

 - name: Load dashboard raw
   ansible.builtin.set_fact:
     dashboard_raw: "{{ lookup('file', dashboard_file) }}"

 - name: Normalize dashboard structure
   ansible.builtin.set_fact:
     dashboard_parsed: "{{ dashboard_raw if (dashboard_raw is mapping) else (dashboard_raw | from_json) }}"

 - name: Determine dashboard UID from file (if present)
   ansible.builtin.set_fact:
     dashboard_uid: "{{ dashboard_parsed.uid | default(dashboard_parsed.dashboard.uid | default('')) }}"

 - name: If UID known, GET existing dashboard by UID
   ansible.builtin.uri:
     url: "{{ grafana_url }}/api/dashboards/uid/{{ dashboard_uid }}"
     method: GET
     headers:
       Authorization: "Bearer {{ grafana_api_key }}"
     return_content: yes
     status_code: [200,404]
     validate_certs: "{{ grafana_validate_certs | default(true) }}"
   register: existing_dashboard_get
   failed_when: false
   when: dashboard_uid | length > 0
   delegate_to: localhost

 - name: Compute file hash
   ansible.builtin.set_fact:
     file_hash: "{{ dashboard_parsed | to_nice_json | hash('sha256') }}"

 - name: Set existing_hash when dashboard exists
   ansible.builtin.set_fact:
     existing_hash: "{{ existing_dashboard_get.json.dashboard | to_nice_json | hash('sha256') }}"
   when: existing_dashboard_get is defined and existing_dashboard_get.status == 200

 - name: Ensure existing_hash is empty when no existing dashboard
   ansible.builtin.set_fact:
     existing_hash: ""
   when: existing_dashboard_get is not defined or existing_dashboard_get.status != 200

 - name: Skip importing when existing dashboard is identical
   ansible.builtin.debug:
     msg: "Skipping import for {{ dashboard_file }} â€” identical dashboard already exists (uid={{ dashboard_uid }})"
   when:
     - dashboard_uid | length > 0
     - existing_dashboard_get is defined
     - existing_dashboard_get.status == 200
     - file_hash == existing_hash

 - name: Prepare payload values
   ansible.builtin.set_fact:
     payload_dashboard:
       id: null
       title: "{{ (dashboard_parsed.dashboard.title if (dashboard_parsed.dashboard is defined and dashboard_parsed.dashboard.title is defined) else (dashboard_parsed.title if (dashboard_parsed.title is defined) else 'Imported Dashboard')) }}"
       tags: "{{ (dashboard_parsed.dashboard.tags if (dashboard_parsed.dashboard is defined and dashboard_parsed.dashboard.tags is defined) else (dashboard_parsed.tags if (dashboard_parsed.tags is defined) else [])) }}"
       timezone: "{{ (dashboard_parsed.dashboard.timezone if (dashboard_parsed.dashboard is defined and dashboard_parsed.dashboard.timezone is defined) else (dashboard_parsed.timezone if (dashboard_parsed.timezone is defined) else 'browser')) }}"
       schemaVersion: "{{ (dashboard_parsed.dashboard.schemaVersion if (dashboard_parsed.dashboard is defined and dashboard_parsed.dashboard.schemaVersion is defined) else (dashboard_parsed.schemaVersion if (dashboard_parsed.schemaVersion is defined) else 27)) }}"
       version: "{{ (dashboard_parsed.dashboard.version if (dashboard_parsed.dashboard is defined and dashboard_parsed.dashboard.version is defined) else (dashboard_parsed.version if (dashboard_parsed.version is defined) else 0)) }}"
     payload_folder_id: 0

 - name: Build import payload
   ansible.builtin.set_fact:
     import_payload:
       dashboard: "{{ payload_dashboard }}"
       overwrite: "{{ grafana_overwrite | default(false) }}"
       folderId: "{{ payload_folder_id }}"
       message: "{{ grafana_commit_message | default('') }}"

 - name: Import dashboard to Grafana (create/update)
   ansible.builtin.uri:
     url: "{{ grafana_url }}/api/dashboards/db"
     method: POST
     headers:
       Authorization: "Bearer {{ grafana_api_key }}"
       Content-Type: "application/json"
     body: "{{ import_payload }}"
     body_format: json
     return_content: yes
     status_code: [200,202]
     validate_certs: "{{ grafana_validate_certs | default(true) }}"
   register: grafana_import_result
   when: not (dashboard_uid | length > 0 and existing_dashboard_get is defined and existing_dashboard_get.status == 200 and file_hash == existing_hash)
   delegate_to: localhost

 - name: Show result for this dashboard
   ansible.builtin.debug:
     var: grafana_import_result



